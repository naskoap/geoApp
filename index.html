<!-- geoApp Geolocation map of Sewanee -->
<html>
  <head>
    <title> Sewanee map </title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=yes">
    <meta charset="utf-8">
    <style>
      html, body, #map-canvas {
        height: 100%;
        margin: 0px;
        padding: 0px
      }
	  #panel {
        position: absolute;
        top: 5px;
        left: 50%;
        margin-left: -180px;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
      }
    </style>
</script> 
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&libraries=places"></script>
    <script src="buildings.js"> </script>
    <script src="coords.js"> </script>
    <script src="direct.js"> </script>
    <script>
  
var map;
var infowindow, infowindow1;
var marker;

//Store markers in an array
var locationArray = [fulford,walsh,mcclurg,allsaints,bookstore,woods,stirlings,sut,gamma];
var locationNameArray = ['Fulford','Walsh-Ellett','McClurg','All Saints Chapel',
'Barnes&Noble','Woods','Stirlings','Thompson Union','Gamma'];

function initialize() {
  
var theCenter = new google.maps.LatLng(35.20438,-85.92016);

var mapOptions = {
    center: theCenter,
    zoom: 17   
    };

  map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  
  //Make polygons interactive - their position in the array is shown upon onMouseClick
  var addListenersOnPolygon = function(polygon) {
  google.maps.event.addListener(polygon, 'click', function (event) {
  alert(polygon.indexID);
  });  
}

 for (var i = 0; i < dormsArray.length; i++) {
    
    var p = new google.maps.Polygon({
    paths: dormsArray[i],
    strokeColor: '#FF0000',
    strokeOpacity: 0.8,
    strokeWeight: 2,
    fillColor: '#FF0000',
    fillOpacity: 0.35,
    indexID: i
    });
    p.setMap(map);
    addListenersOnPolygon(p);
}

 for (var j = 0; j < fratArray.length; j++) {
    
    var q = new google.maps.Polygon({
    paths: fratArray[j],
    strokeColor: '#CCFFEE',
    strokeOpacity: 0.2,
    strokeWeight: 2,
    fillColor: '#CCFF10',
    fillOpacity: 0.35,
    indexID: j
    });
    q.setMap(map);
    addListenersOnPolygon(q);
}    
     var infoArray = [fulfordStr,walshStr,mcclurgStr,allsaintsStr,bookStr,woodsStr,stirlingsStr,sutStr,gammaStr]; 
 
    infowindow = new google.maps.InfoWindow({
    content: ""
    });

    infowindow1 = new google.maps.InfoWindow({
    content: ""
    });
   
    var request = {
    location: theCenter,
    radius: 500,
    };
  
    // Locate the user's current position on the map 
    navigator.geolocation.getCurrentPosition(function(pos) {
    var lat = pos.coords.latitude;
    var lng = pos.coords.longitude;
    directionsDisplay = new google.maps.DirectionsRenderer();
    var latlng = new google.maps.LatLng(lat, lng);

    // Use the geocoder method to transform the geographical coordinates into addresses
    geocoder.geocode({'latLng': latlng}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        if (results[0]) {
              marker = new google.maps.Marker({
              position: latlng,
    	      icon: 'blue-dot.png', // Create a marker in a different color
              map: map
          });
          currentLocation = latlng;
          infowindow1.setContent(results[0].formatted_address);
          infowindow1.open(map, marker);
          } else {
          alert('No results found');
        }
      } else {
        alert('Geocoder failed due to: ' + status);
      }
    });
    directionsDisplay.setMap(map);
  });
  
  // Put a new marker on the preexisting route of point A and point B
  function setMarkerPosition(marker, position) {
     marker.setPosition(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
     console.log(position);}

  // Get and update the user's position
  function watchCurrentPosition() {
    var positionTimer = navigator.geolocation.watchPosition(function(position) {
    setMarkerPosition(userLocation, position);
    map.panTo(new google.maps.LatLng(position.coords.latitude, position.coords.longitude));
    });
}

  var service = new google.maps.places.PlacesService(map);
  service.nearbySearch(request, callback);
      //Construct markers
      for (var i=0; i<locationArray.length; i++) {
      var storeV=infoArray[i];
      marker = new google.maps.Marker({
      position: locationArray[i],
      map: map,
      title: locationNameArray[i]
    });
     
    linkInfoWindow(marker, map, infowindow, storeV);
 }
}   //Connect the description with the appropriate marker
    function linkInfoWindow(marker, map, infowindow, description) {
    google.maps.event.addListener(marker, 'click', function() {
    infowindow.setContent(description);
    infowindow.open(map, marker);
  });
 }

 function callback(results, status) {
  if (status == google.maps.places.PlacesServiceStatus.OK) {
    for (var i = 0; i < results.length; i++) {
      createMarker(results[i]);
    }
  }
}
window.setInterval(navigator.geolocation, 200);
google.maps.event.addDomListener(window, 'load', initialize);
  </script> 
  </head>
  <body>
<div id="panel">
    <b>Directions to</b>
      <!-- Add the locations as coordinates as opposed to addresses -->
      <select id="end" onchange="calcRoute()">
      <option value="(35.21453470927821,-85.9375570689474)">    27 Canterbury</option>
      <option value="(35.202682963315375,-85.91974720108851)"> Gailor Hall</option>
      <option value="(35.20816088524198,-85.9140354369913)">Hospital</option>
      <option value="(35.20485598596547,-85.91960370290622)"> Walsh-Ellett Hall</option>
    </select>
    </div>
  <div id="out"></div>
  <div id="map-canvas"></div>
  </body>
  </html>
